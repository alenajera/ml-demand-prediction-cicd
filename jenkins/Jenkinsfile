pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/AlejandroNajera/ml-demand-prediction-cicd.git'
            }
        }
        stage('Build Docker Image') {
            steps {
                sh 'docker build -t ml-demand-api .'
            }
        }
        stage('Run Container for Testing') {
            steps {
                sh 'docker run -d --name ml_demand_test -p 5000:5000 ml-demand-api'
            }
        }
        stage('Test API Endpoint') {
            steps {
                sh 'sleep 5 && curl -X POST http://127.0.0.1:5000/predict -H "Content-Type: application/json" -d \'{"price":9.0,"ads_spent":750}\''
            }
        }
        stage('Cleanup') {
            steps {
                sh 'docker stop ml_demand_test && docker rm ml_demand_test'
            }
        }
    }
}
